{
    "link": "https://bbs.nga.cn/read.php?tid=40239108",
    "title": "分享写系统巡检脚本的奇怪事",
    "post_time": "2024-05-20 17:24",
    "uid": "60692070",
    "content": "用Python写了个服务器巡检脚本，shell命令在测试服务器验证，tmd，测试服务器系统版本contos7的，生产环境有6、7还有8，命令都不实用，服了醉了累了。",
    "replies": [
        {
            "mid": "42252406",
            "mtime": "2024-05-20 18:11",
            "mcontent": "工程实践的亏建议自己拿什么东西记下来。"
        },
        {
            "mid": "5041763",
            "mtime": "2024-05-20 18:24",
            "mcontent": "用ansible不是省事儿多了"
        },
        {
            "mid": "63453772",
            "mtime": "2024-05-20 21:53",
            "mcontent": "建议建N个和生产系统同配置的docker，在docker里测。"
        },
        {
            "mid": "60692070",
            "mtime": "2024-05-21 08:58",
            "mcontent": "我看看。"
        },
        {
            "mid": "60692070",
            "mtime": "2024-05-21 09:08",
            "mcontent": "借到几台测试的服务器，后面去那上面验证"
        },
        {
            "mid": "63453772",
            "mtime": "2024-05-21 10:27",
            "mcontent": "说起来centos7都不继续支持了，分别提6，这样的系统合适吗……"
        },
        {
            "mid": "60692070",
            "mtime": "2024-05-21 10:35",
            "mcontent": "都是十几年前的架构，今年和厂家断合同，新系统还没影子，没人敢改。前几天做prometheus监控的时候就发现没法做统一，promql没办法在centos6和7上同时适应。"
        },
        {
            "mid": "60692070",
            "mtime": "2024-05-21 13:16",
            "mcontent": "对的，后面开个帖子记录下"
        },
        {
            "mid": "42252406",
            "mtime": "2024-05-21 13:23",
            "mcontent": "究竟是sh部分不适应还是promQL部分不适应啊。后者不就是一个http查询么。"
        },
        {
            "mid": "60692070",
            "mtime": "2024-05-21 13:51",
            "mcontent": "shell遇到的，从top获取cpu使用率，命令是：top -d 1 -n 1 -b | awk 'NR==3{print $8}'，但是centos6的数据是“Cpu(s):  0.2%us,  0.2%sy”这样的，centos7/8是“%Cpu(s):  0.4 us,  0.0 sy,” awk模式使用空格做分隔符，所以获取数据有差异。但是刚想起来都使用“,”做分割，修改命令后是top -d 1 -n 1 -b | awk 'NR==3' | awk -F',' '{print $4}' | awk '{print $1}'，这样都能获取到，但6版本的会多带个%，还是需要再做一次校验。promql中是“node_memory_MemAvailable_bytes”是在新的系统内核提供的，6版本的默认内核版本比较低，又不敢随意升级内核版本。"
        },
        {
            "mid": "42252406",
            "mtime": "2024-05-21 15:35",
            "mcontent": "看看awk后面加个 [0-9]*[.][0-9] 的正则能不能兼容。你的命令看起来只提取数值。"
        },
        {
            "mid": "62055657",
            "mtime": "2024-05-21 18:06",
            "mcontent": "可以加上获取系统版本的判断。"
        },
        {
            "mid": "60692070",
            "mtime": "2024-05-22 09:23",
            "mcontent": "好办法，增加了sed截取。做这么多是为了输出一个报告"
        },
        {
            "mid": "60692070",
            "mtime": "2024-05-22 09:43",
            "mcontent": "在修改了"
        },
        {
            "mid": "63453772",
            "mtime": "2024-05-22 10:24",
            "mcontent": "如果不考虑符号也可以替换掉%"
        },
        {
            "mid": "42252406",
            "mtime": "2024-05-22 10:51",
            "mcontent": "问一嘴，(不方便说也没事)，报告是html形式还是单独的客户端展示。"
        },
        {
            "mid": "60692070",
            "mtime": "2024-05-22 14:41",
            "mcontent": "输出一个pdf报告，类似这样的，比较简单"
        },
        {
            "mid": "60692070",
            "mtime": "2024-05-22 14:44",
            "mcontent": "是的，准备再修改下，现在能用， 已经生成报告了，后面再优化"
        },
        {
            "mid": "42252406",
            "mtime": "2024-05-22 14:54",
            "mcontent": ""
        }
    ]
}